import { useRef } from "react";
import FadingModal from "../FadingModal/FadingModal";
import { TextField, InputAdornment, Button } from "@mui/material";
import { useSelector, useDispatch } from "react-redux";
import { setUser } from "../../stores/reducers";
import "./SettingsModal.css";
import { AppState, UserType } from "../../stores/types";
import api from "../API/api";

interface SettingsModalPropsType {
  open: boolean;
  handleModalClose: () => void;
}

const SettingsModal = ({ open, handleModalClose }: SettingsModalPropsType) => {
  const dispatch = useDispatch();
  const jwt: string | null = useSelector((state: AppState) => state.jwtToken);
  const user: UserType | null = useSelector((state: AppState) => state.user);
  const firstNameRef = useRef<HTMLInputElement>();
  const lastNameRef = useRef<HTMLInputElement>();
  const phoneNumberRef = useRef<HTMLInputElement>();
  const emailRef = useRef<HTMLInputElement>();

  const handleSubmit = () => {
    const updatedUser = {
      firstName: firstNameRef.current?.value || "",
      lastName: lastNameRef.current?.value || "",
      phoneNumber: phoneNumberRef.current?.value || user?.phoneNumber,
      email: emailRef.current?.value || user?.email,
    };

    if (!updatedUser.phoneNumber?.includes("+380")) {
      updatedUser.phoneNumber = "+380" + updatedUser.phoneNumber;
    }

    api
      .put("/user-details", updatedUser, {
        headers: {
          Authorization: `Bearer ${jwt}`,
        },
      })
      .then((response) => {
        const { email, phoneNumber, firstName, lastName, imageUrl } =
          response.data;
        dispatch(
          setUser({ email, phoneNumber, firstName, lastName, imageUrl })
        );
      })
      .catch((error) => {
        console.log(error);
      });

    handleModalClose();
  };

  return (
    <FadingModal open={open} handleModalClose={handleModalClose}>
      <div className="settings-modal-container">
        <div className="user-change-form">
          <TextField
            label="First Name"
            defaultValue={user?.firstName}
            inputRef={firstNameRef}
            variant="outlined"
            margin="normal"
            fullWidth
          />
          <TextField
            label="Last Name"
            defaultValue={user?.lastName}
            inputRef={lastNameRef}
            variant="outlined"
            margin="normal"
            fullWidth
          />
          <TextField
            label="Phone Number"
            defaultValue={user?.phoneNumber?.substring(4)}
            inputRef={phoneNumberRef}
            variant="outlined"
            margin="normal"
            fullWidth
            InputProps={{
              startAdornment: (
                <InputAdornment position="start">+380</InputAdornment>
              ),
            }}
          />
          <TextField
            label="Email"
            defaultValue={user?.email}
            inputRef={emailRef}
            variant="outlined"
            margin="normal"
            fullWidth
          />
        </div>

        <Button
          sx={{
            maxWidth: "600px",
            width: "100%",
            alignSelf: "center",
          }}
          onClick={handleSubmit}
          variant="contained"
          color="primary">
          Save
        </Button>
      </div>
    </FadingModal>
  );
};

export default SettingsModal;
